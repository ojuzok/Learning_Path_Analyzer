name: Learning Path Analysis CI/CD

on:
  # Run on push to main branch
  push:
    branches: [ main ]
  
  # Run on pull requests
  pull_request:
    branches: [ main ]
  
  # Scheduled workflow - runs every day at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * *'
  
  # Manual trigger with parameters
  workflow_dispatch:
    inputs:
      data_file:
        description: 'Data file to analyze'
        required: false
        default: 'data/sample.csv'

jobs:
  # Job 1: Code Quality Checks
  quality:
    runs-on: ubuntu-latest
    name: Code Quality & Linting
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black
    
    - name: Check code formatting with Black
      run: |
        black --check src/ tests/
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

  # Job 2: Unit Tests
  test:
    runs-on: ubuntu-latest
    name: Unit Tests
    needs: quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  # Job 3: Analysis & Report Generation
  analyze:
    runs-on: ubuntu-latest
    name: Generate Analysis Report
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create reports directory
      run: mkdir -p reports
    
    - name: Run analysis
      run: |
        python -m src.main --data ${{ github.event.inputs.data_file || 'data/sample.csv' }} --output reports
    
    - name: Upload analysis reports as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: learning-path-reports
        path: reports/
        retention-days: 30
    
    - name: Create reports branch if it doesn't exist
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git fetch origin reports:reports || git checkout -b reports
        git checkout reports || git checkout --orphan reports
        git rm -rf . || true
      continue-on-error: true
    
    - name: Commit reports to reports branch
      run: |
        git checkout reports || git checkout --orphan reports
        cp -r reports/* . || true
        git add *.png *.txt || true
        git commit -m "Update analysis reports - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push origin reports || git push -u origin reports
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate summary
      run: |
        echo "## Analysis Complete! ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Analysis has been completed successfully." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
        echo "- Correlation heatmap" >> $GITHUB_STEP_SUMMARY
        echo "- Student performance visualizations" >> $GITHUB_STEP_SUMMARY
        echo "- Recommendations report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the **Artifacts** section to download the reports." >> $GITHUB_STEP_SUMMARY
        
        if [ -f reports/recommendations.txt ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -n 20 reports/recommendations.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
